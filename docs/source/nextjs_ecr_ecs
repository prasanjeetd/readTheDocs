
Deploying a Next.js App to ECS Using ECR
========================================

This guide provides a step-by-step process to deploy a Next.js application to Amazon Elastic Container Service (ECS) using Amazon Elastic Container Registry (ECR).

Prerequisites
=============
Before proceeding, ensure you have the following:
- **AWS account** with necessary permissions for ECS, ECR, and IAM.
- **AWS CLI** installed and configured with your credentials.
- **Docker** installed on your local machine.
- **Next.js application** to containerize and deploy.

Step 1: Set Up ECR (Elastic Container Registry)
================================================
Create a repository in ECR to store your Docker images.

1. Log in to the AWS Console.
2. Navigate to **ECR** (Elastic Container Registry).
3. Select **Create Repository**.
4. Give your repository a name (e.g., `nextjs-app`) and configure other settings as needed.
5. Click **Create Repository**.
6. Note down the repository URI, which will be needed for tagging and pushing your Docker image.

Step 2: Create Dockerfile for Next.js Application
=================================================
To containerize your Next.js application, you need a `Dockerfile`. Create this file at the root of your Next.js project.

Here is a sample `Dockerfile`:

.. code-block:: docker

   # Use the official Node.js 16 image as the base image
   FROM node:16-alpine AS builder

   # Set the working directory
   WORKDIR /app

   # Copy package.json and package-lock.json
   COPY package*.json ./

   # Install dependencies
   RUN npm install

   # Copy the rest of the application code
   COPY . .

   # Build the Next.js app
   RUN npm run build

   # Stage 2: Production Environment
   FROM node:16-alpine

   # Set the working directory
   WORKDIR /app

   # Copy built app from Stage 1
   COPY --from=builder /app ./

   # Install only production dependencies
   RUN npm ci --production

   # Expose port 3000
   EXPOSE 3000

   # Start the application
   CMD ["npm", "start"]

Step 3: Build and Tag the Docker Image
=======================================
1. Build the Docker image locally.

   .. code-block:: bash

      docker build -t nextjs-app .

2. Tag the Docker image with the ECR repository URI:

   .. code-block:: bash

      docker tag nextjs-app:latest <account-id>.dkr.ecr.<region>.amazonaws.com/nextjs-app:latest

Step 4: Push Docker Image to ECR
=================================
1. Authenticate Docker with ECR using AWS CLI:

   .. code-block:: bash

      aws ecr get-login-password --region <region> | docker login --username AWS --password-stdin <account-id>.dkr.ecr.<region>.amazonaws.com

2. Push the Docker image to your ECR repository:

   .. code-block:: bash

      docker push <account-id>.dkr.ecr.<region>.amazonaws.com/nextjs-app:latest

Step 5: Set Up ECS Cluster
===========================
1. Log in to the AWS Console.
2. Navigate to **ECS** (Elastic Container Service).
3. Select **Create Cluster**.
4. Choose the **EC2 Linux + Networking** option (or Fargate if preferred) and click **Next**.
5. Configure the cluster and select appropriate instance type, VPC, and other settings.
6. Click **Create**.

Step 6: Create ECS Task Definition
===================================
1. In the ECS Console, navigate to **Task Definitions**.
2. Select **Create new Task Definition**.
3. Choose either **EC2** or **Fargate** depending on your setup.
4. Provide the required configurations:
   - **Task role**: Choose an existing role or create a new one.
   - **Network Mode**: Select the appropriate network mode (usually `awsvpc`).
   - **Container definitions**: Click **Add container**.
     - Set the **Container name** (e.g., `nextjs-app`).
     - Set the **Image**: Use the ECR image URI (e.g., `<account-id>.dkr.ecr.<region>.amazonaws.com/nextjs-app:latest`).
     - Set the **Port mappings**: Map port `3000` to `80`.
     - Set memory and CPU as needed.
   - **Volumes**: Configure any necessary volumes.
5. Click **Create**.

Step 7: Create ECS Service
===========================
1. Navigate to **ECS Services** and click **Create Service**.
2. Select your ECS cluster and **Task Definition**.
3. Set up **Service Name** and the desired number of tasks (instances of your app).
4. Configure the **Load Balancer** if required, or choose to use a **Network Configuration** for public access.
5. Click **Create Service**.

Step 8: Access Your Application
================================
Once the service is up and running, you can access your Next.js application.

1. Navigate to the **EC2** section in the AWS Console.
2. Find the **Public IP** of your ECS instance (if using EC2) or the Load Balancer URL (if using Fargate).
3. Open the IP or URL in your browser to see your deployed Next.js app.

Conclusion
===========
Your Next.js application is now deployed on AWS ECS using ECR for container management. You can further monitor, scale, and manage the application through the ECS console.
